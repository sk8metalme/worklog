# リポジトリパスデコード問題の設計計画

**プロジェクト**: `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup`

**日時**: 2026-01-31T23:37:57.084Z

---

調査が完了しました。設計計画を提示します。

---

# リポジトリパスデコード問題の設計計画

## 調査結果サマリー

### 発見: JSONL エントリに `cwd` フィールドが存在

JSONL ファイルの各エントリには、**元のプロジェクトパスを含む `cwd` フィールド**が存在することを確認しました。

```json
{
  "cwd": "/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup",
  "sessionId": "06310da1-1cae-4ddc-b499-7d6bd21ea162",
  "type": "system",
  ...
}
```

この `cwd` フィールドを利用することで、エンコードされたディレクトリ名をデコードする必要がなくなります。

### エンコーディング問題の再確認

| エンコード名 | 元パス（`cwd` から取得） |
|------------|----------------------|
| `-Users-arigatatsuya-Work-git-github-com-sk8metalme-ai-agent-setup` | `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup` |
| `-Users-arigatatsuya-dotfiles` | `/Users/arigatatsuya/dotfiles` |

---

## 推奨解決策: 案B（extract_knowledge.py で元パスを保存）

### 選択理由

| 案 | 長所 | 短所 | 評価 |
|---|------|------|------|
| **案A: ファイルシステム照合** | 確実 | 複雑、パフォーマンス懸念、再帰的探索が必要 | △ |
| **案B: extract_knowledge.py で `cwd` 抽出** | **シンプル、信頼性高、パフォーマンス良好** | なし | **◎（推奨）** |
| **案C: マッピングテーブル** | 効率的 | 追加ストレージ、同期問題 | ○ |
| **案D: エンコード名をそのまま使用** | 最もシンプル | ユーザー可読性が低い | △ |

**案B が最適な理由:**
1. **情報源が確実**: JSONL エントリ自体に元パスが含まれている
2. **実装がシンプル**: 1箇所の変更で対応可能
3. **パフォーマンス影響なし**: 既に読み込んでいるデータを利用
4. **後方互換性**: 既存の出力フォーマットを維持しつつ、新フィールドを追加

---

## 実装計画

### Phase 1: extract_knowledge.py の修正

**対象ファイル:** `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/plugins/daily-knowledge-sync/skills/daily-knowledge-sync/scripts/extract_knowledge.py`

#### 変更 1: `_extract_candidate()` メソッドに `project_path` フィールドを追加

**現在のコード（153-161行目）:**
```python
return {
    "timestamp": entry.get("timestamp"),
    "role": role,
    "text": text_content,
    "tool_uses": tool_uses,
    "errors": errors,
    "source_file": str(source_file),
    "line_number": line_num,
}
```

**修正後:**
```python
return {
    "timestamp": entry.get("timestamp"),
    "role": role,
    "text": text_content,
    "tool_uses": tool_uses,
    "errors": errors,
    "source_file": str(source_file),
    "line_number": line_num,
    "project_path": entry.get("cwd", ""),  # 元のプロジェクトパスを追加
}
```

#### 変更 2: `extract_from_file()` でファイルレベルの `cwd` を取得（フォールバック用）

一部のエントリ（`file-history-snapshot`, `summary` など）は `cwd` を持たない場合があるため、ファイルの最初のエントリから `cwd` を取得し、フォールバックとして使用します。

**追加するロジック（`extract_from_file()` 内）:**
```python
def extract_from_file(self, jsonl_file: Path, target_date: str) -> list[dict[str, Any]]:
    candidates = []
    target_dt = datetime.strptime(target_date, "%Y-%m-%d")
    next_day = target_dt + timedelta(days=1)
    
    # ファイルレベルの project_path を取得（フォールバック用）
    file_project_path = self._get_file_project_path(jsonl_file)
    
    try:
        with open(jsonl_file) as f:
            for line_num, line in enumerate(f, 1):
                # ... existing code ...
                candidate = self._extract_candidate(
                    entry, source_file, line_num, file_project_path
                )
```

**新規メソッド:**
```python
def _get_file_project_path(self, jsonl_file: Path) -> str:
    """
    Get the project path from the first entry with cwd field.
    
    Args:
        jsonl_file: Path to JSONL file
        
    Returns:
        str: Project path or empty string if not found
    """
    try:
        with open(jsonl_file) as f:
            for line in f:
                try:
                    entry = json.loads(line)
                    cwd = entry.get("cwd")
                    if cwd:
                        return cwd
                except json.JSONDecodeError:
                    continue
    except Exception:
        pass
    return ""
```

**`_extract_candidate()` の修正:**
```python
def _extract_candidate(
    self, entry: dict[str, Any], source_file: Path, line_num: int,
    fallback_project_path: str = ""
) -> dict[str, Any] | None:
    # ... existing code ...
    
    return {
        "timestamp": entry.get("timestamp"),
        "role": role,
        "text": text_content,
        "tool_uses": tool_uses,
        "errors": errors,
        "source_file": str(source_file),
        "line_number": line_num,
        "project_path": entry.get("cwd") or fallback_project_path,
    }
```

---

### Phase 2: SKILL.md の日次まとめ説明を更新（任意）

**対象ファイル:** `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/plugins/daily-knowledge-sync/skills/daily-knowledge-sync/SKILL.md`

Step 4 の「日次まとめ用の記録」セクションを更新し、`source_file` からのデコードではなく `project_path` フィールドを使用するよう明記します。

**変更箇所（373-374行目付近）:**

現在:
```markdown
- 作業リポジトリ一覧（`source_file`パスからリポジトリパスをデコード）
```

修正後:
```markdown
- 作業リポジトリ一覧（候補の `project_path` フィールドから取得）
```

---

### Phase 3: バージョン更新

**対象ファイル:** 
- `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/plugins/daily-knowledge-sync/.claude-plugin/plugin.json`
- `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/.claude-plugin/marketplace.json`

**バージョン:** `1.6.1` → `1.6.2`（後方互換の修正のため PATCH バージョンアップ）

---

## テスト方法

### 1. 単体テスト（手動実行）

```bash
# テスト用のスクリプトを実行
cd /Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/plugins/daily-knowledge-sync/skills/daily-knowledge-sync/scripts

# extract_knowledge.py を実行し、出力を確認
python extract_knowledge.py 2026-01-31

# 出力ファイルの project_path フィールドを確認
jq '.[0:3] | .[] | {project_path, source_file}' /tmp/knowledge_candidates_2026-01-31.json
```

**期待される出力:**
```json
{
  "project_path": "/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup",
  "source_file": "/Users/arigatatsuya/.claude/projects/-Users-arigatatsuya-Work-git-github-com-sk8metalme-ai-agent-setup/xxx.jsonl"
}
```

### 2. 統合テスト（日次同期の実行）

```bash
# daily-knowledge-sync スキルを手動で実行
# last_run.txt を削除して強制実行
rm ~/.claude/daily_knowledge/last_run.txt

# スキルを起動し、日次まとめの「作業リポジトリ一覧」が正しいパスで表示されることを確認
```

**確認ポイント:**
- 日次まとめの「作業リポジトリ一覧」に元のパス（例: `~/Work/git/github.com/sk8metalme/ai-agent-setup`）が表示される
- エンコード名（例: `-Users-arigatatsuya-Work-git-github-com-sk8metalme-ai-agent-setup`）が表示されない

### 3. エッジケーステスト

| ケース | 入力 | 期待される結果 |
|-------|------|--------------|
| 通常エントリ | `cwd` フィールドあり | `project_path` に `cwd` の値 |
| `cwd` なしエントリ | `file-history-snapshot` 等 | フォールバック値を使用 |
| 空の JSONL | ファイルが空 | 候補なし（エラーなし） |
| `cwd` が全くないファイル | 古いバージョンのログ | `project_path` は空文字列 |

---

## 影響範囲

### 変更が必要なファイル

| ファイル | 変更内容 | 影響度 |
|---------|---------|-------|
| `extract_knowledge.py` | `project_path` フィールド追加 | **主要** |
| `SKILL.md` | ドキュメント更新（任意） | 低 |
| `plugin.json` | バージョン更新 | 低 |
| `marketplace.json` | バージョン同期 | 低 |

### 後方互換性

- **完全に後方互換**: 新しい `project_path` フィールドを追加するのみ
- 既存のフィールド（`source_file` 等）は変更なし
- 下流の処理（`process_knowledge_batch.py` 等）は変更不要（`project_path` を使用しない場合でも動作）

---

## Critical Files for Implementation

以下のファイルが実装において重要です:

1. **`/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/plugins/daily-knowledge-sync/skills/daily-knowledge-sync/scripts/extract_knowledge.py`**
   - **理由**: `_extract_candidate()` と `extract_from_file()` に `project_path` 抽出ロジックを追加

2. **`/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/plugins/daily-knowledge-sync/skills/daily-knowledge-sync/SKILL.md`**
   - **理由**: Step 4 の日次まとめ用記録の説明を更新

3. **`/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/plugins/daily-knowledge-sync/.claude-plugin/plugin.json`**
   - **理由**: バージョン番号の更新（1.6.1 → 1.6.2）

4. **`/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/.claude-plugin/marketplace.json`**
   - **理由**: マーケットプレイスのバージョン同期

5. **`/Users/arigatatsuya/.claude/projects/-Users-arigatatsuya-Work-git-github-com-sk8metalme-ai-agent-setup/`**（参照用）
   - **理由**: テスト時に JSONL ファイルの `cwd` フィールドを確認するためのサンプルデータ
