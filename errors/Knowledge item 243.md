# Knowledge item 243

**プロジェクト**: `/Users/arigatatsuya/Work/git/github.com/sk8metalme/WorkNote`

**日時**: 2026-01-31T11:58:37.114Z

---

## ✅ 設計レビュー完了！

お姉さん、設計のバリデーションが完了しましたよ✨

### 📋 レビュー結果サマリー

| 項目 | 結果 |
|------|------|
| **総合評価** | ⚠️ **条件付き合格** |
| **重大な問題** | 1件（修正必須） |
| **軽微な問題** | 3件（推奨修正） |
| **改善提案** | 5件（任意） |
| **レビューレポート** | `docs/michi/20260131-worknote/spec/design-review.md` |

---

### ❌ **重大な問題（必須修正）**

#### CRI-001: XSS対策の欠如

**問題**: Markdownプレビュー時のサニタイゼーションが不明確

**影響**: ユーザーが入力した悪意あるHTMLが実行される可能性

**例**:
```markdown
<img src=x onerror="alert('XSS')">
<script>alert('XSS')</script>
```

**必須対応**: DOMPurifyによるサニタイゼーション実装を設計書に明記

```typescript
import DOMPurify from 'dompurify';
import { marked } from 'marked';

function renderMarkdownSafe(markdown: string): string {
  const rawHTML = marked(markdown);
  const cleanHTML = DOMPurify.sanitize(rawHTML, {
    ALLOWED_TAGS: ['h1', 'h2', 'h3', 'p', 'ul', 'ol', 'li', 'code', 'pre', 'a', 'strong', 'em'],
    ALLOWED_ATTR: ['href', 'class']
  });
  return cleanHTML;
}
```

---

### ⚠️ **軽微な問題（推奨修正）**

1. **LI-001: 依存性注入の設計不足**
   - Git CLIやファイルシステムへの直接依存 → テスト時にモック化が難しい
   - **推奨**: トレイト（Rust）で抽象化

2. **LI-002: 外部依存の抽象化不足**
   - Git CLI、ファイルシステム、tauri-plugin-storeがハードコード
   - **推奨**: インターフェースで抽象化し、テスト容易性を向上

3. **LI-003: ファイル名変換ロジックの不完全性**
   - "CPU高騰対応" → "cpu" となり、情報が失われる
   - **推奨**: ローマ字変換ライブラリ or タイムスタンプ+連番

---

### 💡 **改善提案（任意）**

1. **REC-001: パフォーマンスモニタリング設計**
   - メトリクス収集ポイント追加（起動時間、メモリ使用量等）

2. **REC-002: ログ設計の明示化**
   - ログレベル、出力先、ローテーション定義

3. **REC-003: 設定ファイルバリデーション強化**
   - 不正な設定値への対応

4. **REC-004: Git操作のリトライロジック**
   - ネットワークエラー時の自動リトライ（最大3回、指数バックオフ）

5. **REC-005: 下書き有効期限設定**
   - 古い下書きの自動削除（デフォルト: 30日）

---

### ✅ **良い点**

1. **アーキテクチャの整合性**: C4モデルで明確に設計、責務分離が適切
2. **データモデルの設計**: JSONスキーマで厳密に定義、型安全
3. **セキュリティ**: Git認証情報をアプリ内に保存しない、適切な委譲
4. **エラーハンドリング**: 6種類のエラー型、ユーザーフレンドリーなメッセージ
5. **バリデーション**: フロントエンド+バックエンドで二重チェック

---

### 🎯 次のアクション

#### **必須**: XSS対策の修正

`design.md` の 6.1節（Markdownレンダリング）にDOMPurifyの実装例を追加してください。

お姉さんが代わりに修正しましょうか？それとも、このまま次のステップ（テスト計画 or タスク分割）に進みますか？

以下の選択肢から選んでください：

1. **XSS対策をお姉さんが修正** → design.mdを更新します
2. **このまま次のステップへ** → テスト計画作成（`/michi:plan-tests`）
3. **タスク分割へ** → タスク分割（`/michi:create-tasks`）
4. **レビュー結果を詳しく確認** → design-review.mdを一緒に見ます

どうしますか？
