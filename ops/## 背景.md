# ## 背景

**プロジェクト**: `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup`

**日時**: 2026-01-31T12:04:20.039Z

---

## 背景

notify.sh を修正して以下を実現したい：
1. Ghostty ターミナルアプリを対象に追加
2. 設定ファイル（notify.conf）でターミナルホワイトリストを管理
3. フォールバック時の優先度は設定ファイルの記載順

## 現在の notify.sh の構造

```bash
#!/bin/bash
# stdin からJSON を読み取り
input=$(cat)
# 各フィールドを抽出
cwd=$(echo "$input" | jq -r '.cwd // "Unknown"')
message=$(echo "$input" | jq -r '.message // "タスク完了"')
event=$(echo "$input" | jq -r '.hook_event_name // "Unknown"')
session_id=$(echo "$input" | jq -r '.session_id // ""' | cut -c1-8)
# プロジェクト名を取得
project=$(basename "$cwd")

# 通知を送信
terminal-notifier -title "Claude Code [$project]" -subtitle "📁 $cwd" -message "$message" -group "${cwd}:${event}:${session_id}" -sound "default"

# ===== ウィンドウを最前面にする =====
bring_to_front() {
    local app_name="$1"
    osascript -e "tell application \"$app_name\" to activate" 2>/dev/null
}

# Claude Codeを実行中のアプリを自動検出
detect_and_activate() {
    # 方法1: TERM_PROGRAM 環境変数から検出
    if [[ -n "$TERM_PROGRAM" ]]; then
        case "$TERM_PROGRAM" in
            "iTerm.app") bring_to_front "iTerm"; return ;;
            "vscode") bring_to_front "Visual Studio Code"; return ;;
            "Apple_Terminal") bring_to_front "Terminal"; return ;;
        esac
    fi
    
    # 方法2: 親プロセスから検出
    local ppid_check=$$
    for _ in {1..10}; do
        ppid_check=$(ps -o ppid= -p "$ppid_check" 2>/dev/null | tr -d ' ')
        [[ -z "$ppid_check" || "$ppid_check" == "1" ]] && break
        
        local pname=$(ps -o comm= -p "$ppid_check" 2>/dev/null)
        case "$pname" in
            *iTerm*) bring_to_front "iTerm"; return ;;
            *Code*|*code*) bring_to_front "Visual Studio Code"; return ;;
            *Terminal*) bring_to_front "Terminal"; return ;;
        esac
    done
    
    # 方法3: フォールバック - 実行中のアプリを優先順位で検出
    if pgrep -x "iTerm2" > /dev/null; then
        bring_to_front "iTerm"
    elif pgrep -f "Visual Studio Code" > /dev/null || pgrep -x "Code" > /dev/null; then
        bring_to_front "Visual Studio Code"
    fi
}

detect_and_activate
```

## 既存の設定ファイルパターン（protect-branch.conf）

```bash
PROTECTED_BRANCHES="main|master|develop"
DANGEROUS_OPS="git commit|git push|git merge"
```

## 要件

1. **notify.conf を作成**
   - TERM_PROGRAM のマッピング
   - 親プロセス名のマッピング
   - フォールバック用 pgrep パターン（優先順）
   - Ghostty を含める

2. **notify.sh を修正**
   - 設定ファイルを読み込む
   - ハードコードの case 文を設定ベースに変更
   - フォールバックの優先度は設定ファイルの順序通り
   - 設定ファイルがない場合はデフォルト値で動作（後方互換性）

3. **Ghostty の情報**
   - TERM_PROGRAM: "ghostty"
   - アプリ名: "Ghostty"
   - プロセス名: ghostty

## 設計を提案してください

- notify.conf の形式
- notify.sh の修正方針
- 後方互換性の担保方法
