# 調査結果

**プロジェクト**: `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup`

**日時**: 2026-01-31T12:03:58.339Z

---

調査完了です。以下に調査結果をまとめます。

---

## 調査結果

### 1. global/hooks/ ディレクトリの構成

| ファイル | 用途 | 設定ファイル |
|---------|------|------------|
| `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/global/hooks/notify.sh` | 通知 + ウィンドウ最前面化 | **なし（設定ハードコード）** |
| `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/global/hooks/protect-branch.sh` | 保護ブランチガード | `protect-branch.conf` |
| `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/global/hooks/protect-secrets.sh` | 秘密情報保護 | `protect-secrets.conf` |
| `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/global/hooks/statusline.sh` | ステータスライン表示 | なし（ccstatusline依存） |

### 2. global/ 配下の設定ファイル

| ファイル | 形式 | 用途 |
|---------|------|------|
| `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/global/settings.template.json` | JSON | Claude Code設定テンプレート（permissions, hooks等） |
| `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/global/settings.local.example.json` | JSON | ローカル設定のサンプル（env, permissions等） |
| `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/global/hooks/protect-branch.conf` | シェル変数形式 | ブランチ保護設定 |
| `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup/global/hooks/protect-secrets.conf` | シェル変数形式 | 秘密情報パターン設定 |

### 3. このリポジトリで使われている設定パターン

#### パターンA: シェル変数形式 (.conf) - hooks用
```bash
# protect-branch.conf の例
PROTECTED_BRANCHES="main|master|develop"
DANGEROUS_OPS="git commit|git push|git merge"
BLOCK_MESSAGE="保護ブランチへの直接操作は禁止です。"
```

**特徴:**
- `source` コマンドで直接読み込み
- セキュリティ検証（ファイル所有者チェック）付き
- パイプ区切りの正規表現パターン
- デフォルト値はスクリプト内にハードコード

#### パターンB: JSON形式 - Claude Code設定用
```json
{
  "permissions": { "allow": [...], "denied": [...] },
  "hooks": { "Notification": [...], "PreToolUse": [...] }
}
```

---

## notify.sh の現状分析

現在の `notify.sh` は以下のターミナルアプリを**ハードコード**しています:

```bash
# TERM_PROGRAM による検出
case "$TERM_PROGRAM" in
    "iTerm.app") bring_to_front "iTerm" ;;
    "vscode") bring_to_front "Visual Studio Code" ;;
    "Apple_Terminal") bring_to_front "Terminal" ;;
esac

# 親プロセスによる検出
case "$pname" in
    *iTerm*) bring_to_front "iTerm" ;;
    *Code*|*code*) bring_to_front "Visual Studio Code" ;;
    *Terminal*) bring_to_front "Terminal" ;;
esac

# フォールバック
if pgrep -x "iTerm2" > /dev/null; then ...
elif pgrep -f "Visual Studio Code" > /dev/null || pgrep -x "Code" > /dev/null; then ...
```

---

## 外部設定ファイル化の推奨方法

このリポジトリの既存パターンに従うなら、**シェル変数形式 (.conf)** が最適です。

### 推奨: notify.conf の構造案

```bash
# notify.conf
# ターミナルホワイトリスト設定

# 最前面化を許可するターミナルアプリ（TERM_PROGRAM値:アプリ名のマッピング）
# 形式: TERM_PROGRAM値=アプリ名
TERMINAL_WHITELIST_TERM_PROGRAM=(
    "iTerm.app=iTerm"
    "vscode=Visual Studio Code"
    "Apple_Terminal=Terminal"
)

# 親プロセス名によるマッピング（部分一致:アプリ名）
TERMINAL_WHITELIST_PNAME=(
    "iTerm=iTerm"
    "Code=Visual Studio Code"
    "Terminal=Terminal"
)

# フォールバック検出（pgrep検索パターン:アプリ名、優先順）
TERMINAL_WHITELIST_PGREP=(
    "iTerm2=iTerm"
    "Visual Studio Code=Visual Studio Code"
)
```

### 理由

1. **既存パターンとの一貫性**: `protect-branch.conf`, `protect-secrets.conf` と同じアプローチ
2. **シンプル**: jq不要、`source` で直接読み込み
3. **セキュリティ**: 所有者検証パターンを再利用可能
4. **拡張性**: ユーザーが `~/.claude/hooks/notify.conf` を編集するだけで追加可能
