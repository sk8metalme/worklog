# 調査結果レポート

**プロジェクト**: `/Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup`

**日時**: 2026-01-31T23:35:13.786Z

---

## 調査結果レポート

### 1. extract_knowledge.py の動作

**場所**: `/Users/arigatatsuya/.claude/plugins/cache/ai-agent-setup/daily-knowledge-sync/1.6.1/skills/daily-knowledge-sync/scripts/extract_knowledge.py`

**動作概要**:
- `KnowledgeExtractor` クラスが `~/.claude/projects` ディレクトリから JSONL ファイルを探索
- `source_file` フィールドには JSONL ファイルの**完全な絶対パス**がそのまま保存される（159行目: `str(source_file)`）
- **デコード処理は一切行っていない** - パスをそのまま文字列化して保存

### 2. source_file パスの構造

出力される JSON の `source_file` フィールド例:
```json
{
  "source_file": "/Users/arigatatsuya/.claude/projects/-Users-arigatatsuya-Work-git-github-com-sk8metalme-ai-agent-setup/7cde3f29-f6b4-4fc4-adca-9f8f5b7370ba.jsonl"
}
```

構成要素:
1. `~/.claude/projects/` - Claude Code の projects ディレクトリ
2. `-Users-arigatatsuya-Work-git-github-com-sk8metalme-ai-agent-setup` - **エンコードされたプロジェクトパス**
3. `/<UUID>.jsonl` - セッションファイル

### 3. Claude Code のエンコーディング方式

**変換ルール**（Claude Code CLI が実行）:
- `/` → `-`
- `.` → `-`

**例**:
```
元のパス: /Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup
         ↓
エンコード: -Users-arigatatsuya-Work-git-github-com-sk8metalme-ai-agent-setup
```

### 4. デコードの問題点 - 非可逆エンコーディング

**問題**: このエンコーディングは**非可逆**（情報が失われる）

単純な `-` → `/` 置換では、複数の解釈が可能:
```
エンコード: -Users-arigatatsuya-Work-git-github-com-sk8metalme-ai-agent-setup

可能な解釈:
A: /Users/arigatatsuya/Work/git/github.com/sk8metalme/ai-agent-setup (正解)
B: /Users/arigatatsuya/Work/git/github/com/sk8metalme/ai/agent/setup
C: /Users/arigatatsuya/Work/git-github-com/sk8metalme/ai-agent-setup
```

**曖昧さの原因**:
- 元のファイル名に `-` が含まれる場合（例: `ai-agent-setup`）
- 元のパスに `.` が含まれる場合（例: `github.com`）
- どちらも `-` に変換されるため、区別不能

### 5. 正しいデコード方法

**唯一の確実な方法: ファイルシステムとの照合**

```python
import os
from pathlib import Path

def decode_project_path(encoded_name: str) -> str | None:
    """
    エンコードされたディレクトリ名から元のパスを復元する。
    ファイルシステムを確認して存在するパスを返す。
    """
    if not encoded_name.startswith('-'):
        return None
    
    # 先頭の '-' を '/' に
    path_candidate = encoded_name[1:]  # '-Users-...' → 'Users-...'
    
    # 再帰的に '-' を '/' または '.' に置換して存在確認
    def try_decode(remaining: str, current_path: str) -> str | None:
        if not remaining:
            if os.path.isdir(current_path):
                return current_path
            return None
        
        # '-' の位置を見つける
        dash_pos = remaining.find('-')
        if dash_pos == -1:
            # もう '-' がない
            full_path = current_path + '/' + remaining
            if os.path.isdir(full_path):
                return full_path
            return None
        
        segment = remaining[:dash_pos]
        rest = remaining[dash_pos + 1:]
        
        # 試行1: '-' を '/' として扱う
        result = try_decode(rest, current_path + '/' + segment)
        if result:
            return result
        
        # 試行2: '-' を '.' として扱う（次のセグメントと結合）
        if rest:
            next_dash = rest.find('-')
            if next_dash != -1:
                combined = segment + '.' + rest[:next_dash]
                result = try_decode(rest[next_dash + 1:], current_path + '/' + combined)
                if result:
                    return result
            else:
                combined = segment + '.' + rest
                full_path = current_path + '/' + combined
                if os.path.isdir(full_path):
                    return full_path
        
        return None
    
    return try_decode(path_candidate, '')
```

**より実用的なアプローチ: マッピングテーブル**

```python
def build_project_mapping() -> dict[str, str]:
    """
    ~/.claude/projects/ のディレクトリ名と
    実際のプロジェクトパスの対応テーブルを作成
    """
    projects_dir = Path.home() / '.claude' / 'projects'
    mapping = {}
    
    for encoded_dir in projects_dir.iterdir():
        if not encoded_dir.is_dir():
            continue
        
        # エンコード名から実際のパスを推測してファイルシステムで確認
        actual_path = decode_project_path(encoded_dir.name)
        if actual_path:
            mapping[encoded_dir.name] = actual_path
    
    return mapping
```

### 6. 結論

| 項目 | 内容 |
|------|------|
| エンコーディング方式 | `/` と `.` を `-` に置換 |
| Base64 使用 | **使用していない** |
| 可逆性 | **非可逆**（情報損失あり） |
| デコード方法 | ファイルシステムとの照合が必須 |
| extract_knowledge.py | デコード処理なし、パスをそのまま保存 |

**推奨対応**:
`extract_knowledge.py` やその後続処理で `source_file` からプロジェクトパスを抽出する場合は、**ファイルシステム照合によるデコード関数**を実装するか、**エンコード名をそのまま識別子として使用**することを検討してください。
